name: Bevy WASM F# CI

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'bevy-wasm-fsharp-ref/**'
      - '.github/workflows/bevy-wasm-fsharp-ci.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'bevy-wasm-fsharp-ref/**'
      - '.github/workflows/bevy-wasm-fsharp-ci.yml'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  check:
    name: Check & Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: bevy-wasm-fsharp-ref
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt, clippy
          cache: true

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: bevy-wasm-fsharp-ref/target
          key: ${{ runner.os }}-cargo-build-check-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-check-

      - name: Check formatting
        run: cargo fmt --all --check

      - name: Run clippy
        run: cargo clippy --all --all-features -- -D warnings

  test:
    name: Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: bevy-wasm-fsharp-ref
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          cache: true

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: bevy-wasm-fsharp-ref/target
          key: ${{ runner.os }}-cargo-build-test-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-test-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev libudev-dev

      - name: Run tests
        run: cargo test --all --all-features

  build-native:
    name: Build Native
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: bevy-wasm-fsharp-ref
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          cache: true

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: bevy-wasm-fsharp-ref/target
          key: ${{ runner.os }}-cargo-build-native-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-native-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev libudev-dev

      - name: Build native release
        run: cargo build --release -p app

      - name: Upload native artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bevy-wasm-fsharp-native-${{ github.sha }}
          path: bevy-wasm-fsharp-ref/target/release/app
          retention-days: 7

  build-wasm:
    name: Build WASM
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: bevy-wasm-fsharp-ref
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: wasm32-unknown-unknown
          cache: true

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: bevy-wasm-fsharp-ref/target
          key: ${{ runner.os }}-cargo-build-wasm-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-wasm-

      - name: Install wasm-bindgen-cli
        run: cargo install wasm-bindgen-cli --version 0.2.92

      - name: Build WASM release
        run: cargo build -p app --target wasm32-unknown-unknown --release

      - name: Generate WASM bindings
        run: |
          wasm-bindgen --out-dir wasm/out \
            --target web \
            --no-typescript \
            target/wasm32-unknown-unknown/release/app.wasm

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bevy-wasm-fsharp-wasm-${{ github.sha }}
          path: bevy-wasm-fsharp-ref/wasm/out/
          retention-days: 7

  all-checks-passed:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [check, test, build-native, build-wasm]
    steps:
      - name: Success
        run: echo "All CI checks passed successfully!"
